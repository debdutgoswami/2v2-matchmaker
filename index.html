<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>2v2 Random Match Generator | Debdut Goswami</title>
        <!-- Include Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Include Bootstrap Icons CSS from a different CDN -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
        <!-- Include html2canvas library -->
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
        <style>
            body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            }
            h2 {
            color: #333;
            }
            .name-field {
            margin-bottom: 10px;
            }
            .add-btn, .submit-btn {
            margin-top: 10px;
            }
            /* Adjust the width of the trash icon button */
            .delete-btn {
            min-width: 40px;
            }
            #matches-table {
            margin-top: 20px;
            }
            /* Style for the "vs" column */
            .vs-column {
            color: #6c757d;
            font-weight: 400;
            }
            /* Style for the "Match Count" and "vs" columns */
            .thin-column {
            width: 50px;
            max-width: 50px;
            min-width: 50px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2 class="mt-3">Create Teams and Matches</h2>
            <div id="nameFields" class="row">
                <div class="col-12 col-md-6 offset-md-3">
                    <!-- Here the generated html from addNameField is appended -->
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-6 offset-md-3">
                    <button class="btn btn-success add-btn" onclick="addNameField()">
                    <i class="bi bi-plus"></i> Add
                    </button>
                    <button class="btn btn-primary submit-btn" onclick="submitForm()">Submit</button>
                </div>
            </div>
            <br/>
            <div id="matches-table" class="row">
                <div class="col-12 col-md-6 offset-md-3">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th scope="col" class="thin-column">#</th>
                                <th scope="col">Team A</th>
                                <th scope="col" class="vs-column thin-column">vs</th>
                                <th scope="col">Team B</th>
                            </tr>
                        </thead>
                        <tbody id="matches-body">
                            <!-- Matches will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Display and store the generated datetime -->
        <div class="row">
            <div class="col-12 col-md-6 offset-md-3">
                <p id="datetime-display" class="text-muted"></p>
            </div>
        </div>
        <!-- Share via WhatsApp link -->
        <div class="row">
            <div class="col-12 col-md-6 offset-md-3">
                <button id="share-button" class="btn btn-success" onclick="downloadTableImage()">Download as Image</button>
            </div>
        </div>
        <!-- Include Bootstrap JS and Popper.js -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Function to save data to sessionStorage
            function saveDataToSessionStorage(key, data) {
                console.log(key)
                console.log(data)
                sessionStorage.setItem(key, JSON.stringify(data));
            }
            
            // Function to retrieve data from sessionStorage
            function getDataFromSessionStorage(key) {
                const data = sessionStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            }
            
            function addNameField(name=null) {
                let nameFieldsContainer = document.getElementById('nameFields');
                let nameFieldDiv = document.createElement('div');
                nameFieldDiv.className = 'col-12 col-md-6 offset-md-3';
                let inputGroup = document.createElement('div');
                inputGroup.className = 'input-group name-field';
                let input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.name = 'name[]';
                input.placeholder = 'Enter a name';
                if (name != null) {
                    input.value = name;
                }
                let deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-danger delete-btn';
                deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                deleteButton.onclick = function() {
                    deleteNameField(nameFieldDiv);
                };
                inputGroup.appendChild(input);
                inputGroup.appendChild(deleteButton);
                nameFieldDiv.appendChild(inputGroup);
                nameFieldsContainer.appendChild(nameFieldDiv);
            
                updateDeleteButtonStatus();
            }
            
            function deleteNameField(nameFieldDiv) {
                let nameFieldsContainer = document.getElementById('nameFields');
                if (nameFieldsContainer.contains(nameFieldDiv)) {
                    nameFieldsContainer.removeChild(nameFieldDiv);
                }
            
                updateDeleteButtonStatus();
            }
            
            function updateDeleteButtonStatus() {
                let deleteButtons = document.querySelectorAll('.delete-btn');
                let nameFields = document.querySelectorAll('.name-field');
            
                deleteButtons.forEach(function(button, _) {
                    button.disabled = nameFields.length <= 3;
                });
            }
            
            function submitForm() {
                let nameInputs = document.getElementsByName('name[]');
                if (nameInputs.length < 3){
                    alert('Please fill in atleast 3 names before submitting.');
                }
                let names = [];
            
                for (let i = 0; i < nameInputs.length; i++) {
                    names.push(nameInputs[i].value.trim());
                }
            
                let isFilled = names.every(function(name) {
                    return name !== '';
                });
            
                if (isFilled) {
                    saveDataToSessionStorage('names', names);
                    // Create teams with two members each
                    let teams = createTeams(names);
                    saveDataToSessionStorage('teams', teams);
                    // Assign matches between the teams
                    let matches = assignMatches(teams);
                    saveDataToSessionStorage('matches', matches);
            
                    let currentDatetime = new Date();
                    let formattedDatetime = currentDatetime.toLocaleString();
                    saveDataToSessionStorage('generatedDatetime', formattedDatetime);
            
                    // Display the teams and matches
                    displayMatches(teams, matches, formattedDatetime);
                } else {
                    alert('Please fill in all name fields before submitting.');
                }
            }
            
            function createTeams(names) {
                // Shuffle the array of names
                let shuffledNames = names.sort(function() {
                    return 0.5 - Math.random();
                });
            
                let teams = [];
                while (shuffledNames.length > 1) {
                    // Take two names to form a team
                    let team = shuffledNames.splice(0, 2);
                    teams.push(team);
                }
            
                // If there is one name left, add a team with a single member
                if (shuffledNames.length === 1) {
                    teams.push([shuffledNames[0]]);
                }
            
                return teams;
            }
            
            function assignMatches(teams) {
                let matches = [];
                while (teams.length >= 2) {
                    // Take two teams to form a match
                    let match = teams.splice(0, 2);
                    matches.push(match);
                }
            
                // If there is one team left, add a match with that team having no opponent
                if (teams.length === 1) {
                    matches.push([teams[0]]);
                }
            
                return matches;
            }
            
            function displayMatches(teams, matches, formattedDatetime) {
                let matchesBody = document.getElementById('matches-body');
                matchesBody.innerHTML = '';
            
                matches.forEach(function(match, index) {
                    let matchRow = document.createElement('tr');
            
                    let matchCountCell = document.createElement('td');
                    matchCountCell.className = 'thin-column';
                    matchCountCell.textContent = `${index + 1}`;
                    matchRow.appendChild(matchCountCell);
            
                    let teamACell = document.createElement('td');
                    teamACell.textContent = `${match[0].join(' and ')}`;
                    matchRow.appendChild(teamACell);
            
                    let vsCell = document.createElement('td');
                    vsCell.className = 'vs-column thin-column';
                    vsCell.textContent = 'vs';
                    matchRow.appendChild(vsCell);
            
                    let teamBCell = document.createElement('td');
                    teamBCell.textContent = `${match[1] ? match[1].join(' and ') : 'No opponent'}`;
                    matchRow.appendChild(teamBCell);
            
                    matchesBody.appendChild(matchRow);
                });
                // Display datetime
                let datetimeDisplay = document.getElementById('datetime-display');
                datetimeDisplay.textContent = 'Generated Datetime: ' + formattedDatetime;
                // Call the function to check match data availability
                checkMatchDataAvailability();
            }
            
            function downloadTableImage() {
                let table = document.getElementById('matches-table');
                let formattedDate = document.getElementById('datetime-display');
            
                // Use html2canvas to convert the table to an image
                html2canvas(table).then(function(canvas) {
                    // Convert canvas to a data URL
                    let imageDataUrl = canvas.toDataURL("image/png");
            
                    // Create a link element to trigger the download
                    let link = document.createElement('a');
                    link.href = imageDataUrl;
                    link.download = `matches-${formattedDate.textContent.split(':').slice(1).join(':')}.png`;
            
                    // Trigger the click event to start the download
                    link.click();
                });
            }
            
            // Check if match data is available to enable the share button
            function checkMatchDataAvailability() {
                let matchesBody = document.getElementById('matches-body');
                let shareButton = document.getElementById('share-button');
            
                // Enable the share button only if there are matches available
                shareButton.disabled = matchesBody.children.length === 0;
            }
            
            // On page load, check if there is stored data and display it
            document.addEventListener('DOMContentLoaded', function () {
                let storedNames = getDataFromSessionStorage('names');
                let storedTeams = getDataFromSessionStorage('teams');
                let storedMatches = getDataFromSessionStorage('matches');
                let generatedDatetime = getDataFromSessionStorage('generatedDatetime');
            
                if (storedNames && storedTeams && storedMatches) {
                    let nameInputs = document.getElementsByName('name[]');
                    // nameInputs.forEach((nameInput) => {deleteNameField(nameInput.parentNode.parentNode)})
                    storedNames.forEach((storedName) => {addNameField(storedName)})
                    // Display the stored data
                    displayMatches(storedTeams, storedMatches, generatedDatetime);
                }else{
                    // Add the first five inputs on page load
                    for (let i = 0; i < 3; i++) {
                        addNameField();
                    }
                }
                checkMatchDataAvailability();
            });
        </script>
    </body>
</html>